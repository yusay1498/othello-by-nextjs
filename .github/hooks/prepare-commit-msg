#!/bin/sh
#
# Git hook to help generate commit messages with GitHub Copilot
#

COMMIT_MSG_FILE=$1
COMMIT_SOURCE=$2
SHA1=$3

# Only run for regular commits (not merge, squash, etc.)
if [ -z "$COMMIT_SOURCE" ] || [ "$COMMIT_SOURCE" = "message" ]; then
  # Get the diff of staged changes
  STAGED_DIFF=$(git diff --cached --stat)
  
  # ステージされたファイルの状態を取得
  STAGED_STATUS=$(git diff --cached --name-status)
  
  # ファイル数をカウント
  FILE_COUNT=$(echo "$STAGED_STATUS" | wc -l | tr -d ' ')

  # If there are staged changes and the commit message is empty or contains only comments
  if [ -n "$STAGED_DIFF" ] && { [ ! -s "$COMMIT_MSG_FILE" ] || ! grep -q '^[[:space:]]*[^#[:space:]]' "$COMMIT_MSG_FILE"; }; then
    TEMP_FILE="${COMMIT_MSG_FILE}.tmp"
    cp "$COMMIT_MSG_FILE" "$TEMP_FILE" 2>/dev/null || true

    # 初期メッセージを生成
    INITIAL_MSG=""
    
    if [ "$FILE_COUNT" -eq 1 ]; then
      # 1ファイルの場合、詳細なメッセージを生成
      STATUS=$(echo "$STAGED_STATUS" | awk '{print $1}')
      FILE_PATH=$(echo "$STAGED_STATUS" | awk '{print $NF}')
      FILE_NAME=$(basename "$FILE_PATH")
      
      case "$STATUS" in
        A)
          INITIAL_MSG="Add $FILE_NAME"
          ;;
        M)
          INITIAL_MSG="Update $FILE_NAME"
          ;;
        D)
          INITIAL_MSG="Remove $FILE_NAME"
          ;;
        R*)
          OLD_NAME=$(echo "$STAGED_STATUS" | awk '{print $2}' | xargs basename)
          NEW_NAME=$(echo "$STAGED_STATUS" | awk '{print $3}' | xargs basename)
          INITIAL_MSG="Rename $OLD_NAME to $NEW_NAME"
          ;;
      esac
    else
      # 複数ファイルの場合
      INITIAL_MSG="Update $FILE_COUNT files"
    fi

    # Write initial message and helpful context
    cat > "$COMMIT_MSG_FILE" << EOF
$INITIAL_MSG
# コミットメッセージのガイドライン:
# - 1行目: 必ず先頭大文字の英語で記述
# - プレフィックス（feat:, fix: など）は不要
# - 変更内容を簡潔に記述
# - ピリオド、カンマ、接続詞はできるだけ避ける
# - 1文でかつ50文字以内に収める
#
# ステージされた変更 / Staged changes:
$(printf '%s\n' "$STAGED_DIFF" | head -20 | sed 's/^/# /')
EOF

    if [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
      printf '\n' >> "$COMMIT_MSG_FILE"
      cat "$TEMP_FILE" >> "$COMMIT_MSG_FILE"
      rm -f "$TEMP_FILE"
    fi
  fi
fi